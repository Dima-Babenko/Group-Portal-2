{% extends 'base/base.html' %}

{% load custom_filters %}
{% load custom_tags %}

{% block content %}
<div class="container mt-3">
  <div class="row">
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∑–∞–¥–∞–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="col-md-6 d-flex flex-column">
      <!-- –ó–∞–¥–∞–Ω–∏–µ -->
      <h2>{{ branch.title }}</h2>
      <p>{{ branch.body }}</p>
      <div class="d-flex">
        <a href="{% url 'forum:branch_update' branch.id %}" class="btn btn-outline-warning me-2">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
        <a href="{% url 'forum:branch_delete' branch.id %}" class="btn btn-outline-danger">–í–∏–¥–∞–ª–∏—Ç–∏</a>
      </div>

      <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
      <div class="add-comment mt-4 p-3 border rounded bg-dark text-light" style="background: #f8f9fa;">
        <h4>–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</h4>
        <form action="{% url 'forum:add_comment' branch.id %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="parent_id" id="parent-id-input"> <!-- üëà –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ -->
          <div class="form-group">
            <label for="id_content">–ö–æ–º–µ–Ω—Ç–∞—Ä:</label>
            <textarea name="content" id="id_content" class="form-control text-light" rows="3"
                      style="max-height: 100px; overflow-y: auto;"></textarea>
          </div>
          {{ comment_form.media }}
          <button type="submit" class="btn btn-primary mt-2">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </form>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="col-md-6 d-flex flex-column">
      <div class="comments p-3 border rounded bg-dark text-light" style="max-height: 550px; overflow-y: auto;">
        <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>
        {% for comment in branch.comments.all %}
          {% if not comment.parent %}
            <div class="comment mb-2 p-2 border rounded bg-dark text-light">
              <div class="d-flex align-items-center mb-2">
                {% if comment.author.avatar %}
                  <img src="{{ comment.author.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä"
                       class="rounded-circle me-2" style="width: 50px; height: 50px; object-fit: cover;">
                {% endif %}
                <strong>{{ comment.author.username }}</strong>
              </div>

              <p>{{ comment.content }}</p>

              {% if comment.media %}
                <div class="comment-media mt-2">
                  {% if comment.media.url|lower|endswith:".jpg" or comment.media.url|lower|endswith:".jpeg" or comment.media.url|lower|endswith:".png" or comment.media.url|lower|endswith:".gif" %}
                    <img src="{{ comment.media.url }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è" style="max-width: 100%; height: auto;">
                  {% elif comment.media.url|lower|endswith:".mp4" %}
                    <video width="100%" controls>
                      <source src="{{ comment.media.url }}" type="video/mp4">
                      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ç–µ–≥ video.
                    </video>
                  {% elif comment.media.url|lower|endswith:".mp3" or comment.media.url|lower|endswith:".wav" %}
                    <audio controls style="width: 100%;">
                      <source src="{{ comment.media.url }}">
                      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ –µ–ª–µ–º–µ–Ω—Ç.
                    </audio>
                  {% else %}
                    <a href="{{ comment.media.url }}" download>–°–∫–∞—á–∞—Ç–∏ —Ñ–∞–π–ª</a>
                  {% endif %}
                </div>
              {% endif %}

              <button class="btn btn-sm btn-outline-secondary reply-btn mt-2" data-id="{{ comment.id }}">‚Ü©Ô∏è –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>

              {% if comment.author == request.user %}
                <div class="mt-2">
                  <form method="post" action="{% url 'forum:comment_delete' comment.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                  </form>
                </div>
              {% endif %}

              <!-- –û—Ç–≤–µ—Ç—ã -->
              {% for reply in comment.replies.all %}
                <div class="mt-3 ms-4 border-start ps-3">
                  <strong>{{ reply.author.username }}</strong>
                  <p>{{ reply.content }}</p>
                  {% if reply.media %}
                    <div class="comment-media mt-2">
                      {% if reply.media.url|lower|endswith:".jpg" or reply.media.url|lower|endswith:".jpeg" or reply.media.url|lower|endswith:".png" or reply.media.url|lower|endswith:".gif" %}
                        <img src="{{ reply.media.url }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="max-width: 100%; height: auto;">
                      {% elif reply.media.url|lower|endswith:".mp4" %}
                        <video width="100%" controls>
                          <source src="{{ reply.media.url }}" type="video/mp4">
                        </video>
                      {% elif reply.media.url|lower|endswith:".mp3" or reply.media.url|lower|endswith:".wav" %}
                        <audio controls style="width: 100%;">
                          <source src="{{ reply.media.url }}">
                        </audio>
                      {% else %}
                        <a href="{{ reply.media.url }}" download>–°–∫–∞—á–∞—Ç–∏ —Ñ–∞–π–ª</a>
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if reply.author == request.user %}
                    <form method="post" action="{% url 'forum:comment_delete' reply.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% empty %}
          <p>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.reply-btn').forEach(button => {
    button.addEventListener('click', function () {
      const commentId = this.getAttribute('data-id');
      document.getElementById('parent-id-input').value = commentId;
      document.getElementById('id_content').focus();
    });
  });
</script>
{% endblock %}
